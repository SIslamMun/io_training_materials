name: Release Progress

on:
  schedule:
    - cron: '0 */4 * * *'  # Run every 4 hours
  workflow_dispatch:  # Allow manual triggering

jobs:
  check-progress:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    if: github.repository_owner == 'HDFGROUP'
    steps:
    - name: Checkout repository
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        
    - name: Set up Python
      uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6
      with:
        python-version: '3.11'  # Use specific version for consistency
        
    - name: Cache pip dependencies
      uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb # v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
        
    - name: Install dependencies
      run: |
        pip install requests
        
    - name: Validate required secrets
      run: |
        if [ -z "${{ secrets.GIST_TOKEN }}" ]; then
          echo "::error::GIST_TOKEN secret is required"
          exit 1
        fi
        if [ -z "${{ secrets.GIST_ID }}" ]; then
          echo "::error::GIST_ID secret is required"
          exit 1
        fi
        echo "::notice::All required secrets are present"
        
    - name: Debug information
      if: runner.debug == '1'
      run: |
        echo "Repository: $GITHUB_REPOSITORY"
        echo "Workflow: $GITHUB_WORKFLOW"
        echo "Run ID: $GITHUB_RUN_ID"
        echo "Python version: $(python --version)"
        echo "Environment variables:"
        env | grep -E '^GITHUB_' | sort
        
    - name: Calculate progress
      id: progress
      run: |
        cd .github/workflows
        # Check if Python script exists
        if [ ! -f "update-progress.py" ]; then
          echo "::error::update-progress.py not found in .github/workflows directory"
          exit 1
        fi
        
        echo "::notice::Running progress calculation script..."
        
        # Run the Python script with error handling
        if ! python update-progress.py > progress_output.txt 2>&1; then
          echo "::error::Python script execution failed"
          echo "Script output:"
          cat progress_output.txt
          exit 1
        fi
        
        # Display the captured output for debugging
        echo "=== Python Script Output ==="
        cat progress_output.txt
        echo "=========================="
        
        # Extract and validate percentage
        PERCENTAGE=$(grep "^percentage=" progress_output.txt | cut -d'=' -f2 | head -1)
        if [ -z "$PERCENTAGE" ] || ! [[ "$PERCENTAGE" =~ ^[0-9]+(\.[0-9]+)?$ ]]; then
          echo "::error::Invalid or missing percentage value: '$PERCENTAGE'"
          echo "Expected format: percentage=XX.X"
          exit 1
        fi
        
        # Extract and validate done/total counts
        DONE_TOTAL=$(grep "^Done / Total:" progress_output.txt | cut -d':' -f2 | xargs | head -1)
        if [ -z "$DONE_TOTAL" ]; then
          echo "::error::Missing 'Done / Total:' line in script output"
          exit 1
        fi
        
        DONE=$(echo "$DONE_TOTAL" | cut -d' ' -f1)
        TOTAL=$(echo "$DONE_TOTAL" | cut -d' ' -f3)  # Account for "XX / YY" format
        
        # Validate numeric values
        if ! [[ "$DONE" =~ ^[0-9]+$ ]] || ! [[ "$TOTAL" =~ ^[0-9]+$ ]]; then
          echo "::error::Invalid done/total values: done='$DONE', total='$TOTAL'"
          echo "Expected format: 'Done / Total: XX / YY'"
          exit 1
        fi
        
        # Validate logical consistency
        if [ "$TOTAL" -eq 0 ]; then
          echo "::error::Total count cannot be zero"
          exit 1
        fi
        
        if [ "$DONE" -gt "$TOTAL" ]; then
          echo "::error::Done count ($DONE) cannot exceed total count ($TOTAL)"
          exit 1
        fi
        
        # Extract blocker, must-do, and nice-to-have counts
        BLOCKER_DONE=$(grep "^blocker_done=" progress_output.txt | cut -d'=' -f2 | head -1)
        BLOCKER_TOTAL=$(grep "^blocker_total=" progress_output.txt | cut -d'=' -f2 | head -1)
        MUSTDO_DONE=$(grep "^mustdo_done=" progress_output.txt | cut -d'=' -f2 | head -1)
        MUSTDO_TOTAL=$(grep "^mustdo_total=" progress_output.txt | cut -d'=' -f2 | head -1)
        NICETOHAVE_DONE=$(grep "^nicetohave_done=" progress_output.txt | cut -d'=' -f2 | head -1)
        NICETOHAVE_TOTAL=$(grep "^nicetohave_total=" progress_output.txt | cut -d'=' -f2 | head -1)
        VERSION=$(grep "^version=" progress_output.txt | cut -d'=' -f2 | head -1)

        # Set outputs for use in subsequent steps
        echo "percentage=$PERCENTAGE" >> $GITHUB_OUTPUT
        echo "done=$DONE" >> $GITHUB_OUTPUT
        echo "total=$TOTAL" >> $GITHUB_OUTPUT
        echo "blocker_done=$BLOCKER_DONE" >> $GITHUB_OUTPUT
        echo "blocker_total=$BLOCKER_TOTAL" >> $GITHUB_OUTPUT
        echo "mustdo_done=$MUSTDO_DONE" >> $GITHUB_OUTPUT
        echo "mustdo_total=$MUSTDO_TOTAL" >> $GITHUB_OUTPUT
        echo "nicetohave_done=$NICETOHAVE_DONE" >> $GITHUB_OUTPUT
        echo "nicetohave_total=$NICETOHAVE_TOTAL" >> $GITHUB_OUTPUT
        echo "version=$VERSION" >> $GITHUB_OUTPUT

        echo "::notice::Progress calculation successful: ${PERCENTAGE}% (${DONE}/${TOTAL})"
        echo "::notice::  Version: ${VERSION}, Blockers: ${BLOCKER_DONE}/${BLOCKER_TOTAL}, Must Do: ${MUSTDO_DONE}/${MUSTDO_TOTAL}, Nice to Have: ${NICETOHAVE_DONE}/${NICETOHAVE_TOTAL}"
        
        # Clean up
        rm -f progress_output.txt
        
      env:
        GITHUB_TOKEN: ${{ secrets.GIST_TOKEN }}
        GITHUB_OWNER: "HDFGroup"
        GITHUB_PROJECT_NUMBER: "39"

    - name: Update progress badge Gist
      env:
        GITHUB_TOKEN: ${{ secrets.GIST_TOKEN }}
        GIST_ID: ${{ secrets.GIST_ID }}
        PERCENTAGE: ${{ steps.progress.outputs.percentage }}
        DONE: ${{ steps.progress.outputs.done }}
        TOTAL: ${{ steps.progress.outputs.total }}
        BLOCKER_DONE: ${{ steps.progress.outputs.blocker_done }}
        BLOCKER_TOTAL: ${{ steps.progress.outputs.blocker_total }}
        MUSTDO_DONE: ${{ steps.progress.outputs.mustdo_done }}
        MUSTDO_TOTAL: ${{ steps.progress.outputs.mustdo_total }}
        NICETOHAVE_DONE: ${{ steps.progress.outputs.nicetohave_done }}
        NICETOHAVE_TOTAL: ${{ steps.progress.outputs.nicetohave_total }}
        VERSION: ${{ steps.progress.outputs.version }}
      run: |
        # Execute dedicated badge generation script
        # This separates concerns: YAML orchestrates, scripts implement logic
        bash .github/workflows/update-badge.sh
        
    - name: Cleanup on failure
      if: failure()
      run: |
        echo "::warning::Workflow failed - cleaning up temporary files"
        rm -f progress_output.txt
        echo "::notice::Check the logs above for specific error details"
